/**
 * Script to get an access token for E2E testing using client credentials flow.
 *
 * This uses a service principal with client secret to get an app-only token.
 *
 * Usage:
 *   node scripts/get-e2e-token.cjs
 *
 * The token will be written to .env.e2e.local which is loaded by playwright.config.ts
 */

const { ConfidentialClientApplication } = require('@azure/msal-node');
const fs = require('fs');
const path = require('path');

// Validate required environment variable
if (!process.env.E2E_CLIENT_SECRET) {
  console.error('Error: E2E_CLIENT_SECRET environment variable is required');
  console.error('Set it before running this script:');
  console.error('  export E2E_CLIENT_SECRET=your-client-secret');
  console.error('  npm run test:e2e:auth');
  process.exit(1);
}

// Service Principal configuration
const config = {
  auth: {
    clientId: '82ea9ac5-0639-4493-a8ec-1c6a6bb7b992',
    // For CIAM tenants, use the tenant subdomain format
    authority: 'https://login.microsoftonline.com/bcf802e0-bcbf-4c6b-84df-72538573a5c3',
    clientSecret: process.env.E2E_CLIENT_SECRET,
  },
};

// The scope for client credentials flow - must be the app's own scope (/.default)
const tokenRequest = {
  scopes: ['api://82ea9ac5-0639-4493-a8ec-1c6a6bb7b992/.default'],
};

async function getToken() {
  console.log('Getting access token using client credentials flow...');
  console.log('Client ID:', config.auth.clientId);
  console.log('Authority:', config.auth.authority);

  const cca = new ConfidentialClientApplication(config);

  try {
    const response = await cca.acquireTokenByClientCredential(tokenRequest);

    if (response && response.accessToken) {
      console.log('\n✓ Successfully acquired access token!');
      console.log('Token type:', response.tokenType);
      console.log('Expires:', response.expiresOn);

      // Write to .env.e2e.local
      const envPath = path.join(__dirname, '..', '.env.e2e.local');
      const envContent = `# Auto-generated by get-e2e-token.cjs at ${new Date().toISOString()}
VITE_E2E_ACCESS_TOKEN=${response.accessToken}
`;

      fs.writeFileSync(envPath, envContent);
      console.log(`\n✓ Token written to ${envPath}`);
      console.log('\nYou can now run E2E tests with: npm run test:e2e');

      return response.accessToken;
    } else {
      console.error('No access token in response');
      process.exit(1);
    }
  } catch (error) {
    console.error('\n✗ Failed to acquire token:', error.message);

    if (error.errorCode) {
      console.error('Error code:', error.errorCode);
    }

    if (error.message.includes('AADSTS')) {
      console.error('\nThis might be a configuration issue. Check that:');
      console.error('1. The client secret is correct and not expired');
      console.error('2. The app registration has the required API permissions');
      console.error('3. Admin consent has been granted for the permissions');
    }

    process.exit(1);
  }
}

getToken();
